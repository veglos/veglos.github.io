<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="An Auth Microservice with Clean Architecture" /><meta property="og:locale" content="en_US" /><meta name="description" content="The code of this project is available at https://github.com/veglos/dotnet-auth-microservice" /><meta property="og:description" content="The code of this project is available at https://github.com/veglos/dotnet-auth-microservice" /><link rel="canonical" href="/posts/dotnet-auth-microservice-with-clean-architecture/" /><meta property="og:url" content="/posts/dotnet-auth-microservice-with-clean-architecture/" /><meta property="og:site_name" content="Veglos’ Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-11-08T00:00:00-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="An Auth Microservice with Clean Architecture" /><meta name="twitter:site" content="@twitter_username" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"An Auth Microservice with Clean Architecture","dateModified":"2021-11-12T11:40:49-03:00","datePublished":"2021-11-08T00:00:00-03:00","description":"The code of this project is available at https://github.com/veglos/dotnet-auth-microservice","url":"/posts/dotnet-auth-microservice-with-clean-architecture/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/dotnet-auth-microservice-with-clean-architecture/"},"@context":"https://schema.org"}</script><title>An Auth Microservice with Clean Architecture | Veglos' Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Veglos' Blog"><meta name="application-name" content="Veglos' Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Veglos' Blog</a></div><div class="site-subtitle font-italic">Software Craftmanship</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/veglos" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://www.linkedin.com/in/carlos-eduardo-vega-hern%C3%A1ndez-8b764b37/" aria-label="linkedin" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/3413052/veglos" aria-label="stack-overflow" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>An Auth Microservice with Clean Architecture</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>An Auth Microservice with Clean Architecture</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Carlos Vega Hernandez </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Nov 8, 2021, 12:00 AM -0300" prep="on" > Nov 8, 2021 <i class="unloaded">2021-11-08T00:00:00-03:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Nov 12, 2021, 11:40 AM -0300" prefix="Updated " > Nov 12, 2021 <i class="unloaded">2021-11-12T11:40:49-03:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2338 words">12 min</span></div></div><div class="post-content"><p>The code of this project is available at <a href="https://github.com/veglos/dotnet-auth-microservice">https://github.com/veglos/dotnet-auth-microservice</a></p><h2 id="table-of-contents">Table of contents</h2><hr /><ol><li><a href="#a-clean-architecture">A Clean Architecture</a><li><a href="#the-hexagonal-architecture">The Hexagonal Architecture</a><li><a href="#the-design">The Design</a><ol><li><a href="#use-cases">Use Cases</a></ol><li><a href="#the-auth-microservice">The Auth Microservice</a><ol><li><a href="#what-about-an-api-gateway">What about an API Gateway?</a><li><a href="#oauth-openid-jwt">OAuth 2.0, OpenID Connect, and Json Web Token</a><li><a href="#access-token-vs-refresh-token">Access Token vs Refresh Token</a><li><a href="#jwt-jws-and-jwe">JWT, JWS, and JWE</a><li><a href="#how-do-other-microservices-know-the-access-token-is-legit">How do other microservices know the Access Token is legit?</a></ol><li><a href="#the-project-structure">The Project Structure</a><ol><li><a href="#auth-domain">Auth.Domain</a><li><a href="#auth-application">Auth.Application</a><li><a href="#auth-infrastructure">Auth.Infrastructure</a><li><a href="#auth-api">Auth.API</a></ol><li><a href="#conclusion">Conclusion</a></ol><h2 id="1-a-clean-architecture-">1. A Clean Architecture <a name="a-clean-architecture"></a></h2><hr /><p>In 2012 Robert C. Martin published a blog article called <a href="https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html">The Clean Architecture</a> where he wrote about the common features of different systems, like independence of the framework, independence of the database, independence of the UI, etc. Then in 2017 Martin published the book <a href="https://www.amazon.com/Clean-Architecture-Craftsmans-Software-Structure/dp/0134494164">Clean Architecture</a> that elaborate a further analysis on how a good architecture should be, but most importantly «why».</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-11-08-dotnet-auth-microservice-with-clean-architecture/clean-architecture.jpg" alt="/clean-architecture" /></p><p><em>Figure 1.1: Robert C. Martin’s Clean Architecture Diagram</em></p><h2 id="2-the-hexagonal-architecture-">2. The Hexagonal Architecture <a name="the-hexagonal-architecture"></a></h2><hr /><p>The Hexagonal Architecture was created by Alistair Cockburn in 2005. He has a complete explanation in <a href="https://alistair.cockburn.us/hexagonal-architecture/">his site</a>.</p><p>Also known as the Ports &amp; Adapters architecture pattern, it focuses on the <a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle">Dependency Injection (DI) principle</a> in order to</p><ol type="a"><li>delay the decision of what technology implementation to use, and<li>change technology implementations later easily</ol><p>This pattern relies mainly on four concepts: primary port, primary adapter, secondary port, and secondary adapter. They can be found with different names in literature. See table 2.1.</p><div class="table-wrapper"><table><thead><tr><th>Primary Port<th>Primary Adapter<th>Secondary Port<th>Secondary Adapter<tbody><tr><td>Incoming Port<td>Incoming Adapter<td>Outgoing Port<td>Outgoing Adapter<tr><td>Driving Port<td>Driving Adapter<td>Driven Port<td>Driven Adapter<tr><td>Input Port<td>Input Adapter<td>Output Port<td>Output Adapter</table></div><p><em>Table 2.1: Different names for port and adapters according to different literature</em></p><p><strong>Ports</strong> -both primary and secondary- are just the interfaces that declare what the implementation must do. Conversely, <strong>Adapters</strong> -both primary and secondary- are the respective implementations of the ports.</p><p><strong>Primary</strong> represents a mean to «run» or «drive» the application. It could be a request to get/send data to/from the app or to start a background process. A primary port shows to the «outside world» how the application can be called. On the other hand, <strong>Secondary</strong> represents a mean for the application to interact with resources, like calling a web service or fetching data from a database.</p><p>In summary:</p><ul><li><strong>Primary Port:</strong> Interface exposed by the application for it to be called.<li><strong>Primary Adapter:</strong> Implementation of the Primary Port to call the application.<li><strong>Secondary Port:</strong> Interface exposed by the application for external resources to be called.<li><strong>Secondary Adapter:</strong> Implementation of the Secondary Port to access resources.</ul><p>I made the diagram shown in figure 2.1 to illustrate the difference.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-11-08-dotnet-auth-microservice-with-clean-architecture/hexagonal-architecture.jpg" alt="/hexagonal-architecture" /></p><p><em>Figure 2.1: Hexagonal Architecture diagram</em></p><h2 id="3-the-design-">3. The Design <a name="the-design"></a></h2><hr /><p>From the previous diagrams in figure 1.1 and figure 2.1, I designed the diagram displayed in figure 3.1. I kept the same color scheme to identify the boundaries.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-11-08-dotnet-auth-microservice-with-clean-architecture/clean-1.jpg" alt="/clean-1" /></p><p><em>Figure 3.1: Auth microservice architecture model</em></p><p>The solution is composed of four projects:</p><ul><li><strong>Auth.Domain:</strong> Contains the enterprise business rules in classes (mostly <a href="https://en.wikipedia.org/wiki/Plain_old_CLR_object">POCO</a>). It doesn’t have any dependencies except the .NET Framework itself.<li><strong>Auth.Application:</strong> Contains the application business rules, represented by the use cases. Depends only on the Auth.Domain.<li><strong>Auth.Infrastructure:</strong> Contains the specific implementation of services and repositories. Depends on the Auth.Application and Auth.Domain.<li><strong>Auth.API:</strong> Contains the controllers to be called by the user, and in turn, call the use cases. It also hosts the Microsoft Dependency Injection Container which explains why it depends not only on Auth.Domain and Auth.Application, but also Auth.Infrastructure *.</ul><p>*<em>note</em>: It is possible to avoid the Auth.Infrastructure dependency by creating a DI Container project. I believe it’s not worth the inconvenience in this situation, but it’s totally possible.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-11-08-dotnet-auth-microservice-with-clean-architecture/clean-2.jpg" alt="/clean-2" /></p><p><em>Figure 3.2: Dependency relationship between projects</em></p><h3 id="31-use-cases-">3.1. Use Cases <a name="use-cases"></a></h3><p>Use cases are the heart of the application, they execute the business rules. Here are some quotes from Uncle Bob:</p><blockquote><p><em>Indeed, this is the first concern of the architect, and the first priority of the architecture. The architecture must support the use case</em></p><p>– Martin, R.C. (2017). In Chapter 16 Independence. Clean Architecture (p. 148). Prentice Hall.</p></blockquote><blockquote><p><em>The most important thing a good architecture can do to support behavior is to clarify and expose that behavior so that the intent of the system is visible at the architectural level</em></p><p>– Martin, R.C. (2017). In Chapter 16 Independence. Clean Architecture (p. 148). Prentice Hall.</p></blockquote><blockquote><p><em>[…], use cases are narrow vertical slices that cut through the horizontal layers of the system. Each use case uses some UI, […] business rules […], and some database functionality</em></p><p>– Martin, R.C. (2017). In Chapter 16 Independence. Clean Architecture (p. 152). Prentice Hall.</p></blockquote><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-11-08-dotnet-auth-microservice-with-clean-architecture/clean-3.jpg" alt="/clean-3" /></p><p><em>Figure 3.3: Use cases cutting through the horizontal layers</em></p><p>Our Auth microservice has two main use cases: Login use case and Refresh Token use case.</p><p>Given the login credentials, the Login use case returns an Access Token and a Refresh Token. The Access Token can be used by the client application to access other microservices that trust the Auth microservice. The Refresh Token is needed to get a new Access Token. More on this later.</p><h2 id="4-the-auth-microservice-">4. The Auth Microservice <a name="the-auth-microservice"></a></h2><hr /><p>An Auth Microservice is a centralized authority that grants authentication and authorization (Auth for short) to a user to allow her/him access to a resource provided by other systems (i.e. other microservices) that trust said authority.</p><p>Nowadays it is imperative for most microservices to have authentication and authorization, and while it is possible to implement them in every microservice, it is far more convenient to rely on an Auth Microservice. We don’t want to login (ask for credentials) in every single microservice. Let the microservice focus on the scope they were meant to handle, nothing more.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-11-08-dotnet-auth-microservice-with-clean-architecture/auth-microservice.jpg" alt="/auth-microservice" /></p><p><em>Figure 4.1: The Auth Microservice handles the authentication and authorization of the user/client</em></p><h3 id="41-what-about-an-api-gateway-">4.1. What about an API Gateway? <a name="what-about-an-api-gateway"></a></h3><p><a href="https://microservices.io/patterns/apigateway.html">The API Gateway</a> may or may not handle authentication and authorization, and it can have more responsibilities than that, like response caching, circuit breaker, load balancing, etc., but it’s main purpose is to be a single entry point to the entire system.</p><h3 id="42-oauth-20-openid-connect-and-json-web-token-">4.2. OAuth 2.0, OpenID Connect, and Json Web Token <a name="oauth-openid-jwt"></a></h3><p>There are Id Tokens and Access Tokens. Id Tokens hold information about who the user is (claims), and <strong>the intended recipient is the client application</strong> (i.e. to show “Welcome Carlos!”, etc.). On the other hand, Access Tokens hold information about what can be done (scopes) in a resource (i.e. fetch the user’s photos, etc.), therefore <strong>the intended recipient of such token is the user’s resource</strong>. Figure 5.1 depicts how an Access Token works.</p><p>The Id Token is defined by the <a href="https://openid.net/connect/">OpenID Connect Specification</a>, whereas the Access Token is defined by the <a href="https://oauth.net/2/">OAuth 2.0 Specification</a>. The former must be sent in a <a href="https://jwt.io/">JSON Web Token (JWT)</a> format, the latter can be any string, including JWT.</p><p><strong>It is not the scope of this article to deal with the Client App (or any front-end project for that matter), hence I dealt mostly with Access Tokens, not so much ID Tokens.</strong></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-11-08-dotnet-auth-microservice-with-clean-architecture/auth-sequence.jpg" alt="auth-sequence" /></p><p><em>Figure 4.2: Sequence diagram of the process of authorization by Access Token</em></p><h3 id="43-access-token-vs-refresh-token-">4.3. Access Token vs Refresh Token <a name="access-token-vs-refresh-token"></a></h3><p>There is a third and last type of token called the Refresh Token.</p><p>As previously mentioned, the Access Token allows the user to access a resource, however it has a short lifespan, and depending on the system, it could last between 5 minutes and 1 hour. This is important because if for some reason the Access Token get stolen, the attacker could only make use of it for a short time.</p><p>However, we don’t want to keep asking the user for her/his credentials in order ot get a new Access Token every 5 minutes. That’s why we issue a Refresh Token, which has a long lifespan, usually between 1 day and 1 week, and can be used by the client application to get a brand new Access Token without prompting the user with a login screen every time.</p><p>But could the Refresh Token also be stolen&gt; Yes, but since a Refresh Token is assigned to a single user, it can be disabled and be forced to re-login again, preventing the attacker from getting a new Access Token.</p><p>Access Tokens cannot be disabled, unless we change the Private-Public key pairs, but that would disable every single token in circulation.</p><h3 id="44-jwt-jws-and-jwe-">4.4. JWT, JWS, and JWE <a name="jwt-jws-and-jwe"></a></h3><p>Prabath Siriwardena does a wonderful explanation in his article <a href="https://medium.facilelogin.com/jwt-jws-and-jwe-for-not-so-dummies-b63310d201a3">JWT, JWS and JWE for Not So Dummies!</a>. Basically, as the <a href="https://www.rfc-editor.org/rfc/rfc7519">RFC 7519</a> says, JWT is a mean of representing claims (or scopes) between two parties, but the actual implementation occurs as a JSON Web Signature (JWS) or a JSON Web Encryption (JWE), or a combination of both. JWS encodes and signs the payload, whereas JWE encrypts the payload.</p><p>For this project I used JWT with JWS, and while it is possible to implement your own JWT library, it is highly recommended to use an already tested and popular library like the ones listed on <a href="https://jwt.io/libraries">https://jwt.io/libraries</a>. I used the Microsoft’s System.IdentityModel.Tokens.Jwt library.</p><h3 id="45-how-do-other-microservices-know-the-access-token-is-legit-">4.5. How do other microservices know the Access Token is legit? <a name="how-do-other-microservices-know-the-access-token-is-legit"></a></h3><p>There are two possible ways for a microservice to recognize that the Access Token received is actually from the Auth Microservice and not a malicious impostor (and/or that the payload has not been modified). The two ways are by a <strong>shared secret key</strong> or by a <strong>public-private key pair</strong>.</p><p>A shared secret key is used when the Auth Microservice uses <strong>symmetric</strong> cryptography to sign the payload. Another microservice would need to know the same secret key (hence a shared secret) in order to verify if the payload is true.</p><p>A public-private key pair is used when the Auth Microservice uses asymmetric cryptography to sign the payload, that is, it still requires a private key to sign it, but the verification can be done with just the public key, which as its name implies, it can be publicly distributed to the world without compromising the private key.</p><p>It is safer to keep the signing key (private key) in the Auth Microservice and only share the public key, no matter how much you trust the other microservices. That’s why this project uses <strong>asymmetric</strong> cryptography.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/2021-11-08-dotnet-auth-microservice-with-clean-architecture/asymmetric.jpg" alt="asymmetric" /></p><p><em>Figure 4.3: Simplified example of asymmetric cryptography</em></p><h2 id="5-the-project-structure-">5. The Project Structure <a name="the-project-structure"></a></h2><hr /><p>As stated before, the solution is made of four projects.</p><h3 id="51-authdomain-">5.1. Auth.Domain <a name="auth-domain"></a></h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Auth.Domain /
├─ User.cs
├─ RefreshToken.cs
├─ Claims.cs
</pre></table></code></div></div><p>The first and most important layer. It contains the enterprise business rules. It is quite simple because the RefreshToken class and the Claims class are part of the User class, so it could have been just a single .cs file.</p><p>The scope of the Auth Microservice is narrow. The domain classes are enough to encompass the authentication and authorization.</p><h3 id="52-authapplication-">5.2. Auth.Application <a name="auth-application"></a></h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>Auth.Application /
├─ Enums
├─ Exceptions
├─ Ports /
   ├─ Repositories
   ├─ Services
├─ UseCases
   ├─ CreateUser /
   ├─ Login /
   ├─ RefreshToken /
   ├─ SignOut /
   ├─ IUseCase.cs
   ├─ Request.cs
   ├─ Response.cs
</pre></table></code></div></div><blockquote><p><em>Just as the plans for a house or a library scream about the use cases of those buildings, so should the architecture of a software application scream about the use cases of the application</em></p><p>– Martin, R.C. (2017). In Chapter 21 Screaming Architecture. Clean Architecture (p. 196). Prentice Hall.</p></blockquote><p>Auth.Application holds the “screaming” part of the architecture that tells us what the system do. Just by looking at the UseCase folder, it is apparent what the application does: Create a user, Log in, refresh a token, and sign out.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>Auth.Application /
├─ Ports /
   ├─ Repositories /
      ├─ IAuthRepository.cs
   ├─ Services /
      ├─ IAuthTokenService.cs
      ├─ ICryptographyService.cs
</pre></table></code></div></div><p>If we zoom in a little bit, the Ports folder declares the interfaces of the implementations that the use cases will need in order to be executed. That means <strong>all ports here are secondary/output ports</strong>.</p><h3 id="53-authinfrastructure-">5.3. Auth.Infrastructure <a name="auth-infrastructure"></a></h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>Auth.Infrastructure /
├─ Repositories /
   ├─ MongoDB /
      ├─ Scripts /
      ├─ AuthRepository.cs
      ├─ MongoDbSettings.cs
├─ Services /
   ├─ Cryptography
      ├─ CryptographyService.cs
   ├─ Jwt
      ├─ JwtService.cs
      ├─ JwtSettings.cs

</pre></table></code></div></div><p>This project contains the secondary adapters. Basically, every external infrastructure that is not fundamental for the behavior of the application, like third-party services or databases. For example, changing from SQL Server to PostgreSQL or MongoDB does not change the behavior of the application (asi in, the use cases).</p><h3 id="54-authapi-">5.4. Auth.API <a name="auth-api"></a></h3><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Auth.API /
├─ Controllers /
   ├─ AuthController.cs
├─ Program.cs
├─ Startup.cs
├─ appsettings.json
</pre></table></code></div></div><p>This layer in particular has two roles.</p><p>First, it is an HTTP API primary adapter: It receives HTTP requests and converts them into request objects that the application can process.</p><p>Second, it is a <a href="https://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection Container</a> that knows how to instantiate and configure objects in runtime in order to be injected in the application when it requires it. This project uses the Microsoft.Extensions.DependencyInjection library. It is common practice to do this in an ASP.NET Core Web API project, since most application will only have HTTP Requests as inputs, so it’s easier to do this right here rather than creating another project for the DI Container. This is the reason why the Auth.API project depends on the Auth.Infrastructure project *.</p><p><em>*note: If the DI Container where in another project, for instance and Auth.DIContainer project, then the Auth.API project wouldn’t need to depend on the Auth.Infrastrutcure project. It’s just a matter of convenience why I did it this way.</em></p><h2 id="6-conclusion-">6. Conclusion <a name="conclusion"></a></h2><hr /><p><em>There’s no silver bullet</em>. There are many ways to implement a clean architecture, and many more ways to keep improving it forever. The important thing here is to grasp and understand the concepts and know how to identify them.</p><p>We must have a clear-cut boundary between layers and the direction of dependencies. The implementation of new features immediately <em>“smell weird”</em> when the boundaries are not taken into consideration. For example, if the Auth.Application requires to import a third-party library to access an Excel document then there is a clear violation of the dependency rule (the application cannot depend on the infrastructure), and necessary measures are required to correct it.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/example/'>example</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/aspnetcore/" class="post-tag no-text-decoration" >aspnetcore</a> <a href="/tags/dotnet/" class="post-tag no-text-decoration" >dotnet</a> <a href="/tags/c/" class="post-tag no-text-decoration" >c#</a> <a href="/tags/microservice/" class="post-tag no-text-decoration" >microservice</a> <a href="/tags/clean/" class="post-tag no-text-decoration" >clean</a> <a href="/tags/hexagonal/" class="post-tag no-text-decoration" >hexagonal</a> <a href="/tags/architecture/" class="post-tag no-text-decoration" >architecture</a> <a href="/tags/jwt/" class="post-tag no-text-decoration" >jwt</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://www.linkedin.com/sharing/share-offsite/?url=/posts/dotnet-auth-microservice-with-clean-architecture/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/simple-solid/">Simple SOLID</a><li><a href="/posts/dotnet-auth-microservice-with-clean-architecture/">An Auth Microservice with Clean Architecture</a><li><a href="/posts/setup-django-and-docker/">Setup Django and Docker</a><li><a href="/posts/deploy-jekyll-in-docker/">Deploy Jekyll in Docker</a><li><a href="/posts/google-signin-with-aspnetcore-web-api/">Google Sign In with ASP.NET Core Web API</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/aspnetcore/">aspnetcore</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/clean/">clean</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/social/">social</a> <a class="post-tag" href="/tags/architecture/">architecture</a> <a class="post-tag" href="/tags/c/">c#</a> <a class="post-tag" href="/tags/django/">django</a> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/facebook/">facebook</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/google-signin-with-aspnetcore-web-api/"><div class="card-body"> <span class="timeago small" > May 2, 2021 <i class="unloaded">2021-05-02T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Google Sign In with ASP.NET Core Web API</h3><div class="text-muted small"><p> I couldn’t find a simple, short and straight to the point article about this topic, so I made my own. The complete project is hosted on https://github.com/veglos/dotnet-google-signin-api. Diagram ...</p></div></div></a></div><div class="card"> <a href="/posts/facebook-signin-with-aspnetcore-web-api/"><div class="card-body"> <span class="timeago small" > May 5, 2021 <i class="unloaded">2021-05-05T00:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Facebook Sign In with ASP.NET Core Web API</h3><div class="text-muted small"><p> Similar to my previous post Google Sign In with ASP.NET Core Web API, now with Facebook. The complete project is hosted on https://github.com/veglos/dotnet-facebook-signin-api. Diagram diagram o...</p></div></div></a></div><div class="card"> <a href="/posts/simple-solid/"><div class="card-body"> <span class="timeago small" > Jan 30 <i class="unloaded">2022-01-30T00:00:00-03:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Simple SOLID</h3><div class="text-muted small"><p> Table of contents Single-Responsibility Principle Open-Closed Principle Liskov Substitution Principle Interface Segregation Principle Dependency Inversion Principle 1. Single-Respons...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/setup-django-and-docker/" class="btn btn-outline-primary" prompt="Older"><p>Setup Django and Docker</p></a> <a href="/posts/simple-solid/" class="btn btn-outline-primary" prompt="Newer"><p>Simple SOLID</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//veglos.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'An Auth Microservice with Clean Architecture'; this.page.url = '/posts/dotnet-auth-microservice-with-clean-architecture/'; this.page.identifier = '/posts/dotnet-auth-microservice-with-clean-architecture/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://github.com/veglos">Carlos Vega Hernandez</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/aspnetcore/">aspnetcore</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/clean/">clean</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/social/">social</a> <a class="post-tag" href="/tags/architecture/">architecture</a> <a class="post-tag" href="/tags/c/">c#</a> <a class="post-tag" href="/tags/django/">django</a> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/facebook/">facebook</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
